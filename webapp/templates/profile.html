{% extends "base.html" %}
{% block title %}Perfil - Equatio{% endblock %}

{% block content %}
<section class="profile-layout">

  <!-- Sidebar (menu à esquerda) -->
  <aside class="profile-sidebar">
    <div class="sidebar-group">
      <button class="sidebar-item active" data-target="view-perfil">Perfil</button>
      <button class="sidebar-item" data-target="view-modelos">Modelos</button>
      <button class="sidebar-item" data-target="view-creditos">Créditos</button>
    </div>
  </aside>

  <!-- Conteúdo à direita -->
  <section class="profile-content">

    <!-- PERFIL -->
    <div class="profile-view" id="view-perfil" style="display:block;">

      <!-- Bloco: Dados Pessoais -->
      <div class="about-card">
        <h2 class="view-title">Dados Pessoais</h2>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            <div class="alerts">
              {% for category, message in messages %}
                <div class="alert {{ category }}">{{ message }}</div>
              {% endfor %}
            </div>
          {% endif %}
        {% endwith %}

        <form method="post" class="auth-form" id="form-pessoais">
          <input type="hidden" name="section" value="pessoais">

          <div class="grid-2">
            <div>
              <label>Nome</label>
              <input type="text" name="first_name" value="{{ user.name or '' }}" disabled required>
            </div>
            <div>
              <label>Sobrenome</label>
              <input type="text" name="last_name" value="{{ user.last_name or '' }}" disabled>
            </div>
          </div>

          <div>
            <label>Endereço</label>
            <input type="text" name="address" value="{{ user.address or '' }}" disabled>
          </div>

          <div>
            <label>CPF</label>
            <input type="text" name="cpf" value="{{ user.cpf or '' }}" disabled>
          </div>

          <div class="auth-actions">
            <button type="button" class="btn-login" data-edit="pessoais">Editar</button>
            <div style="display:flex; gap:8px;">
              <button type="button" class="btn" data-cancel="pessoais" style="display:none;">Cancelar</button>
              <button type="submit" class="btn btn-primary" data-save="pessoais" style="display:none;">Salvar</button>
            </div>
          </div>
        </form>
      </div>

      <!-- Bloco: Acadêmico / Profissional -->
      <div class="about-card" style="margin-top:16px;">
        <h2 class="view-title">Informações Acadêmicas/Profissionais</h2>

        <form method="post" class="auth-form" id="form-academico">
          <input type="hidden" name="section" value="academico">

          <div class="grid-2">
            <div>
              <label>Formação</label>
              <input type="text" name="education" value="{{ user.education or '' }}" disabled>
            </div>
            <div>
              <label>Profissão</label>
              <input type="text" name="profession" value="{{ user.profession or '' }}" disabled>
            </div>
          </div>

          <div>
            <label>Empresa</label>
            <input type="text" name="company" value="{{ user.company or '' }}" disabled>
          </div>

          <div class="auth-actions">
            <button type="button" class="btn-login" data-edit="academico">Editar</button>
            <div style="display:flex; gap:8px;">
              <button type="button" class="btn" data-cancel="academico" style="display:none;">Cancelar</button>
              <button type="submit" class="btn btn-primary" data-save="academico" style="display:none;">Salvar</button>
            </div>
          </div>
        </form>
      </div>
    </div>

        <!-- MODELOS -->
    <div class="profile-view" id="view-modelos" style="display:none;">
      <h2 class="view-title">Seus modelos</h2>

      <!-- Card: Modelos cadastrados (tabela) -->
      <div class="about-card">
        <h3 class="about-title">Modelos cadastrados</h3>
        <p class="about-text" style="margin:6px 0 12px;">
          Estes são os modelos que você salvou no Eq.py (customizados por usuário).
        </p>

        {% if user_models and user_models|length %}
          <div style="overflow:auto;">
            <table style="width:100%; border-collapse: collapse;">
              <thead>
                <tr style="border-bottom: 1px solid #e6e6e6;">
                  <th style="text-align:left; padding:8px;">Nome</th>
                  <th style="text-align:left; padding:8px;">Tipo</th>
                  <th style="text-align:left; padding:8px;">Parâmetros</th>
                  <th style="text-align:left; padding:8px;">Variáveis</th>
                  <th style="text-align:left; padding:8px;">Solver</th>
                  <th style="text-align:left; padding:8px;">maxfev</th>
                  <th style="text-align:left; padding:8px;">Chutes iniciais</th>
                  <th style="text-align:left; padding:8px;">Criado em</th>
                  <th style="text-align:left; padding:8px;">Atualizado em</th>
                </tr>
              </thead>
              <tbody>
                {% for m in user_models %}
                  <tr style="border-bottom: 1px solid #f0f0f0;">
                    <td style="padding:8px; font-weight:600;">{{ m.name }}</td>
                    <td style="padding:8px;">
                      {% if m.kind == 'vars' %}Multivariado{% else %}Univariado{% endif %}
                    </td>
                    <td style="padding:8px;">
                      <code class="mono">{{ m.params or '—' }}</code>
                    </td>
                    <td style="padding:8px;">
                      {% if m.kind == 'vars' %}
                        <code class="mono">{{ m.vars_list or '—' }}</code>
                      {% else %}
                        <span style="color:#888">—</span>
                      {% endif %}
                    </td>
                    <td style="padding:8px;">{{ m.solver or 'trf' }}</td>
                    <td style="padding:8px;">{{ m.maxfev or 20000 }}</td>
                    <td style="padding:8px;">
                      {% if m.init_kind == 'manual' %}
                        <span class="token-badge">manual</span>
                        <code class="mono">{{ m.init_values or '—' }}</code>
                      {% else %}
                        <span class="token-badge">auto</span>
                      {% endif %}
                    </td>
                    <td style="padding:8px;">
                      {{ m.created_at.strftime('%d/%m/%Y %H:%M') if m.created_at else '—' }}
                    </td>
                    <td style="padding:8px;">
                      {{ m.updated_at.strftime('%d/%m/%Y %H:%M') if m.updated_at else '—' }}
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <p class="about-text">Você ainda não cadastrou modelos.</p>
        {% endif %}
      </div>

      <!-- Card: Histórico (você pode preencher depois com uma tabela de UserFitHistory) -->
      <div class="about-card" style="margin-top:16px;">
        <h3 class="about-title">Histórico</h3>
        <p class="about-text">Veja ajustes e métricas recentes (r, r², RMSE, Bias).</p>
        {% if fit_history and fit_history|length %}
          <ul class="mono" style="margin:0; padding-left:18px;">
            {% for h in fit_history %}
              <li>
                {{ h.created_at.strftime('%d/%m/%Y %H:%M') if h.created_at else '—' }}
                — <strong>{{ h.eq_name }}</strong>
                — r={{ '%.4f'|format(h.r or 0) }}, r²={{ '%.4f'|format(h.r2 or 0) }},
                  RMSE={{ '%.4f'|format(h.rmse or 0) }}, Bias={{ '%.4f'|format(h.bias or 0) }}
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="about-text">Sem histórico por enquanto.</p>
        {% endif %}
      </div>
    </div>


    <!-- CRÉDITOS (empilhado, vertical como Perfil) -->
    <div class="profile-view" id="view-creditos" style="display:none;">

      <!-- Saldo e consumo -->
      <div class="about-card">
        <h2 class="view-title">Créditos</h2>
        <p class="about-text">Saldo atual: <strong>{{ user.credits or 0 }}</strong> tokens</p>
        <p class="about-text">Última recarga: {{ user.last_topup_at.strftime('%d/%m/%Y %H:%M') if user.last_topup_at else '—' }}</p>
      </div>

      <!-- Comprar tokens (substitui "Gerenciar plano") -->
      <div class="about-card" style="margin-top:16px;">
        <h3 class="about-title">Comprar tokens</h3>
        <p class="about-text">Escolha um pacote para continuar modelando sem limites.</p>

        <div class="grid-2" style="gap:12px; margin-top:10px;">
          <button class="btn" id="buy-50"  data-pack="50">+50 tokens</button>
          <button class="btn" id="buy-200" data-pack="200">+200 tokens</button>
        </div>

        <div class="grid-2" style="gap:12px; margin-top:10px;">
          <button class="btn" id="buy-500"  data-pack="500">+500 tokens</button>
          <button class="btn" id="buy-1000" data-pack="1000">+1000 tokens</button>
        </div>

        <small class="about-text" style="display:block; margin-top:10px;">
          Pagamentos processados com segurança via Stripe.
        </small>
      </div>

      <!-- Histórico de créditos -->
      <div class="about-card" style="margin-top:16px;">
        <h3 class="about-title">Histórico de créditos</h3>
        {% if topups and topups|length %}
          <ul class="mono" style="margin:0; padding-left:18px;">
            {% for t in topups %}
              <li>{{ t.created_at.strftime('%d/%m/%Y %H:%M') }} — +{{ t.amount }} tokens — {{ t.status }}</li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="about-text">Nenhuma compra registrada ainda.</p>
        {% endif %}
      </div>
    </div>

  </section>
</section>

<script>
  // Tabs (menu lateral)
  (function(){
    const buttons = document.querySelectorAll('.sidebar-item');
    const views = document.querySelectorAll('.profile-view');
    function show(id){
      views.forEach(v => v.style.display = (v.id === id ? 'block' : 'none'));
      buttons.forEach(b => b.classList.toggle('active', b.dataset.target === id));
    }
    buttons.forEach(btn => btn.addEventListener('click', () => show(btn.dataset.target)));
  })();

  // Editar/Salvar/Cancelar por seção (pessoais/academico)
  (function(){
    function setEditMode(section, on){
      const form = document.getElementById('form-' + section);
      if(!form) return;
      const inputs = form.querySelectorAll('input');
      inputs.forEach(i => i.disabled = !on);
      form.querySelector(`[data-edit="${section}"]`).style.display   = on ? 'none' : '';
      form.querySelector(`[data-cancel="${section}"]`).style.display = on ? '' : 'none';
      form.querySelector(`[data-save="${section}"]`).style.display   = on ? '' : 'none';
    }
    ['pessoais','academico'].forEach(sec => {
      const form = document.getElementById('form-' + sec);
      if(!form) return;
      form.querySelector(`[data-edit="${sec}"]`).addEventListener('click', () => setEditMode(sec, true));
      form.querySelector(`[data-cancel="${sec}"]`).addEventListener('click', () => {
        form.reset();
        setEditMode(sec, false);
      });
      form.addEventListener('submit', () => setEditMode(sec, false));
    });
  })();

  // Comprar tokens (Stripe Checkout)
  (function(){
    // Se usar CSRF em POST via fetch:
    const csrfInput = document.querySelector('input[name="csrf_token"]');
    const CSRF = csrfInput ? csrfInput.value : null;

    async function comprarTokens(pack) {
      try {
        const resp = await fetch('{{ url_for("billing.billing_create_checkout") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            ...(CSRF ? {'X-CSRFToken': CSRF} : {})
          },
          body: JSON.stringify({ pack })
        });
        const data = await resp.json();
        if (data.url) {
          window.location.href = data.url;
        } else {
          alert(data.error || 'Falha ao iniciar checkout.');
        }
      } catch (e) {
        alert('Erro de rede ao iniciar checkout.');
      }
    }

    ['buy-50','buy-200','buy-500','buy-1000'].forEach(id => {
      const el = document.getElementById(id);
      if (el) el.addEventListener('click', () => comprarTokens(el.dataset.pack));
    });
  })();
</script>
{% endblock %}
